var Direction;!function(t){t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT"}(Direction||(Direction={}));var Operation;!function(t){t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT"}(Operation||(Operation={}));var Block;!function(t){t[t.EMPTY=0]="EMPTY",t[t.ORDINARY=1]="ORDINARY",t[t.IRON=2]="IRON",t[t.MUBAN=3]="MUBAN",t[t.LIGHT=4]="LIGHT",t[t.HEAVY=5]="HEAVY",t[t.FLASH=6]="FLASH",t[t.END=7]="END"}(Block||(Block={}));var State;!function(t){t[t.GAMING=0]="GAMING",t[t.SUCCESS=1]="SUCCESS",t[t.FAILURE=2]="FAILURE"}(State||(State={}));var millisec=10,GameView=function(){function t(t,e){this.scene=Laya.stage.addChild(new Laya.Scene);var a=this.scene.addChild(new Laya.Camera(0,.1,100));a.transform.translate(new Laya.Vector3(-5,6,20)),a.transform.rotate(new Laya.Vector3(-5,-30,0),!0,!1),a.clearColor=null,this.parent=e,this.messageQueue=new Array,this.messageBusy=!1,this.canOperate=!1,Laya.loader.load(t,Laya.Handler.create(this,this.loadView,[t]),null,Laya.Loader.JSON)}return t.prototype.loadView=function(t){var e=Laya.Loader.getRes(t);this.light_range=3,this.light_height=3,this.light_global_on=e.light_on,this.BLOCK_URL=e.url_block,this.BLOCK_IRON_URL=e.url_iron,this.BLOCK_MUBAN_URL=e.url_muban,this.CUBE_URL=e.url_cube,this.map_info=e.map,this.MAX_LENGTH=e.map_length,this.MAX_WIDTH=e.map_width,this.start_pos=e.startpos,this.cube_pos_init=new Laya.Vector3(this.start_pos[0],0,this.start_pos[1]),this.cube1_pos=new Laya.Vector3(this.cube_pos_init.x,this.cube_pos_init.y,this.cube_pos_init.z),this.cube2_pos=new Laya.Vector3(this.cube_pos_init.x,this.cube_pos_init.y+1,this.cube_pos_init.z),this.light_global_on&&this.loadDirectionLight(),this.loadMap(),this.loadCube(),this.loadSelfLight(),this.loadSpotLight(),this.updateLightPos()},t.prototype.loadMap=function(){var t=new Laya.StandardMaterial;t.diffuseTexture=Laya.Texture2D.load(this.BLOCK_URL);var e=new Laya.StandardMaterial;e.diffuseTexture=Laya.Texture2D.load(this.BLOCK_IRON_URL);var a=new Laya.StandardMaterial;a.diffuseTexture=Laya.Texture2D.load(this.BLOCK_MUBAN_URL),this.map=new Array;for(var i=0;i<this.MAX_WIDTH;i++){this.map[i]=new Array;for(var o=0;o<this.MAX_LENGTH;o++)switch(this.map_info[o][i]){case Block.EMPTY:break;case Block.ORDINARY:this.map[i][o]=this.scene.addChild(new Laya.MeshSprite3D(new Laya.BoxMesh(1,1,.1))),this.map[i][o].transform.translate(new Laya.Vector3(i,-1.05,o),!0),this.map[i][o].meshRender.material=t;break;case Block.IRON:this.map[i][o]=this.scene.addChild(new Laya.MeshSprite3D(new Laya.BoxMesh(1,1,.1))),this.map[i][o].transform.translate(new Laya.Vector3(i,-1.05,o),!0),this.map[i][o].meshRender.material=e;break;case Block.MUBAN:this.map[i][o]=this.scene.addChild(new Laya.MeshSprite3D(new Laya.BoxMesh(1,1,.1))),this.map[i][o].transform.translate(new Laya.Vector3(i,-1.05,o),!0),this.map[i][o].meshRender.material=a;break;case Block.LIGHT:case Block.HEAVY:case Block.FLASH:this.map[i][o]=this.scene.addChild(new Laya.MeshSprite3D(new Laya.BoxMesh(1,1,.1))),this.map[i][o].transform.translate(new Laya.Vector3(i,-1.05,o),!0),this.map[i][o].meshRender.material=t;break;case Block.END:}}},t.prototype.loadCube=function(){this.cube=this.scene.addChild(new Laya.MeshSprite3D(new Laya.BoxMesh(1,1,2)));var t=new Laya.StandardMaterial;t.diffuseTexture=Laya.Texture2D.load(this.CUBE_URL),t.albedo=new Laya.Vector4(6,6,6,.9),t.renderMode=Laya.StandardMaterial.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE,this.cube.meshRender.material=t;this.cube.transform.position=new Laya.Vector3(this.cube_pos_init.x,10,this.cube_pos_init.z),this.fall_in(10)},t.prototype.loadSelfLight=function(){this.light=this.scene.addChild(new Laya.PointLight),this.light.range=this.light_range,this.light.attenuation=new Laya.Vector3(1,1,1)},t.prototype.loadSpotLight=function(){this.spotLight=this.scene.addChild(new Laya.SpotLight),this.spotLight.direction=new Laya.Vector3(0,-1,0),this.spotLight.range=100,this.spotLight.spot=12,this.spotLight.attenuation=new Laya.Vector3(.01,.01,.01)},t.prototype.loadDirectionLight=function(){this.directionLight=this.scene.addChild(new Laya.DirectionLight),this.directionLight.color=new Laya.Vector3(.5,.5,.5),this.directionLight.direction=new Laya.Vector3(0,-1,0)},t.prototype.moveUp=function(){var t=new Laya.Vector3((this.cube1_pos.x+this.cube2_pos.x)/2,-1,Math.min(this.cube1_pos.z,this.cube2_pos.z)-.5);this.lastMove=Direction.UP,this.moveAni(t,new Laya.Vector3(-10,0,0),9)},t.prototype.moveDown=function(){var t=new Laya.Vector3((this.cube1_pos.x+this.cube2_pos.x)/2,-1,Math.max(this.cube1_pos.z,this.cube2_pos.z)+.5);this.lastMove=Direction.DOWN,this.moveAni(t,new Laya.Vector3(10,0,0),9)},t.prototype.moveLeft=function(){var t=new Laya.Vector3(Math.min(this.cube1_pos.x,this.cube2_pos.x)-.5,-1,(this.cube1_pos.z+this.cube2_pos.z)/2);this.lastMove=Direction.LEFT,this.moveAni(t,new Laya.Vector3(0,0,10),9)},t.prototype.moveRight=function(){var t=new Laya.Vector3(Math.max(this.cube1_pos.x,this.cube2_pos.x)+.5,-1,(this.cube1_pos.z+this.cube2_pos.z)/2);this.lastMove=Direction.RIGHT,this.moveAni(t,new Laya.Vector3(0,0,-10),9)},t.prototype.fallUp=function(){this.fallAni(new Laya.Vector3(-10,0,0),27)},t.prototype.fallDown=function(){this.fallAni(new Laya.Vector3(10,0,0),27)},t.prototype.fallLeft=function(){this.fallAni(new Laya.Vector3(0,0,10),27)},t.prototype.fallRight=function(){this.fallAni(new Laya.Vector3(0,0,-10),27)},t.prototype.fallUp_half=function(t){this.fallHalfAni(t,new Laya.Vector3(-10,0,0),9)},t.prototype.fallDown_half=function(t){this.fallHalfAni(t,new Laya.Vector3(10,0,0),9)},t.prototype.fallLeft_half=function(t){this.fallHalfAni(t,new Laya.Vector3(0,0,10),9)},t.prototype.fallRight_half=function(t){this.fallHalfAni(t,new Laya.Vector3(0,0,-10),9)},t.prototype.moveAni=function(t,e,a){var i=this,o=0,s=null;clearInterval(s),s=setInterval(function(){i.doRotate(t,e),++o>=a&&(clearInterval(s),i.updateCubePos(),i.checkState())},millisec)},t.prototype.fallAni=function(t,e){var a=this,i=0,o=null;clearInterval(o),o=setInterval(function(){a.doFall(a.cube.transform.position,t),++i>=e&&(clearInterval(o),console.log("fail"),a.restart())},millisec)},t.prototype.fallHalfAni=function(t,e,a){var i=this,o=0,s=null;clearInterval(s),s=setInterval(function(){i.doRotate(t,e),++o>=a&&(clearInterval(s),i.updateCubePos(),i.fallAni(e,27))},millisec)},t.prototype.fallStraightWinAni=function(t,e){var a=this,i=0,o=null;clearInterval(o),o=setInterval(function(){a.doFallStraight(t),++i>=e&&(clearInterval(o),console.log("success"),a.goToNext())},millisec)},t.prototype.fallStraightLoseAni=function(t,e){var a=this,i=0,o=null;clearInterval(o),o=setInterval(function(){a.doFallStraight(t),++i>=e&&(clearInterval(o),console.log("red"),a.restart())},millisec)},t.prototype.fallInAni=function(t,e){var a=this,i=0,o=null;clearInterval(o),o=setInterval(function(){a.doFallStraight(t),++i>=e&&(clearInterval(o),a.canOperate=!0)},millisec)},t.prototype.restartAni=function(t){var e=this,a=0,i=null;clearInterval(i),i=setInterval(function(){e.doDark(),++a>=t&&(clearInterval(i),e.parent.restart())},millisec)},t.prototype.doFall=function(t,e){this.myRotate(t,e),this.myFallStraight(.5),this.updateLightPos()},t.prototype.doRotate=function(t,e){this.myRotate(t,e),this.updateLightPos()},t.prototype.doFallStraight=function(t){this.myFallStraight(t),this.updateLightPos()},t.prototype.doDark=function(){this.spotLight.attenuation=new Laya.Vector3(this.spotLight.attenuation.x,this.spotLight.attenuation.y+.03,this.spotLight.attenuation.z),this.light_global_on&&(this.directionLight.color=new Laya.Vector3(this.directionLight.color.x-.05,this.directionLight.color.y-.05,this.directionLight.color.z-.05))},t.prototype.myFallStraight=function(t){this.cube.transform.position=new Laya.Vector3(this.cube.transform.position.x,this.cube.transform.position.y-t,this.cube.transform.position.z)},t.prototype.myRotate=function(t,e){var a=new Laya.Quaternion;Laya.Quaternion.createFromYawPitchRoll(e.y/180*Math.PI,e.x/180*Math.PI,e.z/180*Math.PI,a),this.cube.transform.rotate(e,!1,!1);var i=new Laya.Vector3(this.cube.transform.position.x-t.x,this.cube.transform.position.y-t.y,this.cube.transform.position.z-t.z),o=new Laya.Vector3;Laya.Vector3.transformQuat(i,a,o),this.cube.transform.position=new Laya.Vector3(o.x+t.x,o.y+t.y,o.z+t.z)},t.prototype.updateLightPos=function(){this.light.transform.position=this.cube.transform.position,this.spotLight.transform.position=new Laya.Vector3(this.light.transform.position.x,this.light_height,this.light.transform.position.z)},t.prototype.updateCubePos=function(){var t=Math.round(2*this.cube.transform.position.x)/2,e=Math.round(2*this.cube.transform.position.y)/2,a=Math.round(2*this.cube.transform.position.z)/2;this.cube.transform.position=new Laya.Vector3(t,e,a),this.updateLightPos();var i=Math.floor(t),o=Math.floor(a);i===t&&o===a?(this.cube1_pos=new Laya.Vector3(i,0,o),this.cube2_pos=new Laya.Vector3(i,1,o)):i===t?(this.cube1_pos=new Laya.Vector3(i,0,o),this.cube2_pos=new Laya.Vector3(i,0,2*a-o)):o===a?(this.cube1_pos=new Laya.Vector3(i,0,o),this.cube2_pos=new Laya.Vector3(2*t-i,0,o)):console.log("updateCubePos需要异常处理！")},t.prototype.fall_full=function(t){switch(this.canOperate=!1,t){case Direction.UP:this.fallUp();break;case Direction.DOWN:this.fallDown();break;case Direction.LEFT:this.fallLeft();break;case Direction.RIGHT:this.fallRight();break;default:console.log("fall_full需要异常处理！")}},t.prototype.fall_half=function(t,e){if(this.canOperate=!1,t.x>e.x){a=new Laya.Vector3(t.x-.5,-1,t.z);this.fallRight_half(a)}else if(t.x<e.x){a=new Laya.Vector3(t.x+.5,-1,t.z);this.fallLeft_half(a)}else if(t.z>e.z){a=new Laya.Vector3(t.x,-1,t.z-.5);this.fallDown_half(a)}else if(t.z<e.z){var a=new Laya.Vector3(t.x,-1,t.z+.5);this.fallUp_half(a)}else console.log("fall_half需要异常处理！")},t.prototype.fall_straight_win=function(){this.canOperate=!1,this.fallStraightWinAni(.2,9)},t.prototype.fall_in=function(t){this.fallInAni(1,t)},t.prototype.checkFall=function(){var t,e;if(t=this.cube1_pos.x>=this.MAX_WIDTH||this.cube1_pos.x<0||this.cube1_pos.z>=this.MAX_LENGTH||this.cube1_pos.z<0||this.map_info[this.cube1_pos.z][this.cube1_pos.x]===Block.EMPTY,e=this.cube2_pos.x>=this.MAX_WIDTH||this.cube2_pos.x<0||this.cube2_pos.z>=this.MAX_LENGTH||this.cube2_pos.z<0||this.map_info[this.cube2_pos.z][this.cube2_pos.x]===Block.EMPTY,!0===t&&!0===e)return this.fall_full(this.lastMove),State.FAILURE;if(!0===t)return this.fall_half(this.cube1_pos,this.cube2_pos),State.FAILURE;if(!0===e)return this.fall_half(this.cube2_pos,this.cube1_pos),State.FAILURE;var a=this.map_info[this.cube1_pos.z][this.cube1_pos.x]===Block.END,i=this.map_info[this.cube2_pos.z][this.cube2_pos.x]===Block.END;return!0===a&&!0===i?(this.fall_straight_win(),State.SUCCESS):State.GAMING},t.prototype.checkState=function(){var t=this.checkFall();t!==State.FAILURE&&t!==State.SUCCESS&&t===State.GAMING&&this.checkMessageQueue()},t.prototype.restart=function(){this.restartAni(30)},t.prototype.goToNext=function(){},t.prototype.addMessage=function(t){this.canOperate&&(this.messageQueue.push(t),this.messageBusy||(this.messageBusy=!0,this.checkMessageQueue()))},t.prototype.checkMessageQueue=function(){if(this.canOperate)if(0!==this.messageQueue.length){switch(this.messageQueue.shift()){case Operation.UP:this.moveUp();break;case Operation.DOWN:this.moveDown();break;case Operation.LEFT:this.moveLeft();break;case Operation.RIGHT:this.moveRight();break;default:console.log("checkMessageQueue需要异常处理！")}}else this.messageBusy=!1},t}();